<!DOCTYPE html>
<html lang="ja" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord Bot Builder (Public Edition)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gray: {
                            750: '#2d3748',
                            850: '#1a202c',
                            950: '#0d1117',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Blockly Library (å¤–éƒ¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ãƒ­ãƒ¼ãƒ‰) -->
    <script src="https://unpkg.com/blockly@9.0.0/blockly.min.js"></script>
    <script src="https://unpkg.com/blockly@9.0.0/python_compressed.js"></script>
    <script src="https://unpkg.com/blockly@9.0.0/msg/ja.js"></script>
    
    <!-- Icons (Lucide) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Inter', sans-serif; transition: background-color 0.3s, color 0.3s; }
        
        /* Blocklyã‚¨ãƒ‡ã‚£ã‚¿ã®ã‚³ãƒ³ãƒ†ãƒŠ */
        #blocklyDiv {
            height: 100%;
            width: 100%;
            position: absolute;
            z-index: 10;
        }

        /* ãƒ„ãƒ¼ãƒ«ãƒœãƒƒã‚¯ã‚¹ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º */
        .blocklyToolboxDiv {
            background-color: #f8fafc;
            border-right: 1px solid #e2e8f0;
            padding-top: 1rem;
        }
        .dark .blocklyToolboxDiv {
            background-color: #111827;
            border-right: 1px solid #374151;
        }

        .blocklyTreeLabel {
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            padding: 8px 0;
            font-size: 0.95rem;
        }
        
        .blocklyTreeRow {
            height: 44px !important;
            line-height: 44px !important;
            padding-left: 16px !important;
            border-left: 5px solid transparent;
            margin-bottom: 6px;
            transition: all 0.2s ease;
            border-radius: 0 8px 8px 0;
            margin-right: 12px;
        }
        
        /* Light Mode */
        .blocklyTreeRow:not(.blocklyTreeSelected):hover {
            background-color: #e2e8f0;
            border-left-color: #cbd5e1;
        }
        .blocklyTreeSelected {
            background-color: #eff6ff !important;
            border-left-color: #3b82f6 !important;
            color: #2563eb !important;
        }

        /* Dark Mode */
        .dark .blocklyTreeLabel { color: #e5e7eb; }
        .dark .blocklyTreeRow:not(.blocklyTreeSelected):hover {
            background-color: #1f2937;
            border-left-color: #4b5563;
        }
        .dark .blocklyTreeSelected {
            background-color: #1e3a8a !important;
            border-left-color: #60a5fa !important;
            color: #93c5fd !important;
        }
        .dark .blocklyFlyoutBackground {
            fill: #1f2937;
            fill-opacity: 0.95;
        }

        /* ã‚³ãƒ¼ãƒ‰å‡ºåŠ›ã‚¨ãƒªã‚¢ */
        #codeOutput {
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            line-height: 1.5;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .modal-content {
            transform: scale(0.95);
            opacity: 0;
            transition: all 0.2s ease-out;
        }
        .show-modal .modal-content {
            transform: scale(1);
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-100 flex flex-col h-screen overflow-hidden transition-colors duration-300">

    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="bg-white dark:bg-gray-800 shadow-sm px-6 py-3 flex justify-between items-center z-20 border-b border-gray-200 dark:border-gray-700">
        <div class="flex items-center gap-3">
            <div class="bg-gradient-to-br from-indigo-500 to-purple-600 p-2 rounded-lg shadow-md">
                <i data-lucide="bot" class="w-6 h-6 text-white"></i>
            </div>
            <div>
                <h1 class="text-xl font-bold text-gray-800 dark:text-white leading-tight">Discord Bot Builder</h1>
                <p class="text-xs font-medium text-indigo-600 dark:text-indigo-400">Public Edition (Python)</p>
            </div>
        </div>

        <div class="flex items-center gap-3">
            <span id="saveStatus" class="mr-2 text-xs font-bold text-green-600 opacity-0 transition-opacity duration-500 dark:text-green-400">ä¿å­˜ã—ã¾ã—ãŸ</span>

            <!-- ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œãƒœã‚¿ãƒ³ -->
            <input type="file" id="importInput" accept=".xml" class="hidden">
            <button id="importBtn" class="p-2 text-gray-600 transition-colors rounded-lg bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600" title="ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’èª­è¾¼ (XML)">
                <i data-lucide="upload" class="w-5 h-5"></i>
            </button>
            <button id="exportBtn" class="p-2 text-gray-600 transition-colors rounded-lg bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600" title="ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä¿å­˜ (XML)">
                <i data-lucide="download" class="w-5 h-5"></i>
            </button>

            <div class="w-px h-6 mx-1 bg-gray-300 dark:bg-gray-600"></div>

            <button id="themeToggle" class="p-2 transition-colors rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 dark:text-gray-300 text-gray-600" title="ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆ">
                <i data-lucide="moon" class="hidden w-5 h-5 dark:block"></i>
                <i data-lucide="sun" class="block w-5 h-5 dark:hidden"></i>
            </button>

            <button id="showCodeBtn" class="flex items-center gap-2 px-5 py-2 font-medium text-white transition-all transform rounded-lg shadow-lg bg-indigo-600 hover:bg-indigo-700 hover:shadow-indigo-500/30 hover:-translate-y-0.5">
                <i data-lucide="code" class="w-4 h-4"></i>
                <span class="hidden sm:inline">ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ</span>
            </button>
        </div>
    </header>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ -->
    <main class="relative w-full h-full flex-grow">
        <div id="blocklyDiv"></div>
        
        <!-- ãƒ„ãƒ¼ãƒ«ãƒœãƒƒã‚¯ã‚¹å®šç¾© (å¤šæ©Ÿèƒ½åŒ– & ã‚ã‹ã‚Šã‚„ã™ã„æ—¥æœ¬èª) -->
        <xml id="toolbox" style="display: none">
            <category name="ã‚¤ãƒ™ãƒ³ãƒˆ" colour="#e67e22">
                <block type="on_ready"></block>
                <block type="on_message_create"></block>
                <block type="on_command_executed"></block>
                <block type="prefix_command"></block>
                <block type="get_message_content"></block>
                <block type="get_command_arg"></block>
            </category>
            
            <category name="æƒ…å ±å–å¾—" colour="#8e44ad">
                <block type="get_user_info"></block>
                <block type="get_channel_info"></block>
                <block type="get_server_info"></block>
            </category>

            <category name="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸" colour="#3498db">
                <block type="reply_message"></block>
                <block type="send_channel_message"></block>
                <block type="edit_reply"></block>
                <block type="delete_message"></block>
                <block type="purge_messages"></block>
                <block type="pin_message"></block>
                <block type="add_reaction"></block>
                <block type="create_thread"></block>
            </category>
            
            <category name="ãƒãƒ£ãƒ³ãƒãƒ«æ“ä½œ" colour="#3498db">
                <block type="create_text_channel"></block>
                <block type="delete_channel"></block>
            </category>

            <category name="Botè¨­å®š" colour="#9b59b6">
                <block type="set_bot_status"></block>
                <block type="wait_seconds"></block>
            </category>

            <category name="ç®¡ç†æ©Ÿèƒ½" colour="#e74c3c">
                <block type="timeout_user"></block>
                <block type="kick_user"></block>
                <block type="ban_user"></block>
                <block type="add_user_role"></block>
                <block type="remove_user_role"></block>
                <block type="create_role"></block>
                <block type="change_nickname"></block>
            </category>
            
            <category name="åŸ‹ã‚è¾¼ã¿ (Embed)" colour="#2ecc71">
                <block type="create_embed"></block>
                <block type="set_embed_property"></block>
                <block type="add_embed_field"></block>
            </category>

            <sep></sep>
            
            <!-- å¤‰æ•°ã‚«ãƒ†ã‚´ãƒª (æ¨™æº–æ©Ÿèƒ½) -->
            <category name="å¤‰æ•°" colour="#a55b6a" custom="VARIABLE"></category>

            <!-- ãƒªã‚¹ãƒˆã‚«ãƒ†ã‚´ãƒª (æ¨™æº–ãƒ–ãƒ­ãƒƒã‚¯) -->
            <category name="ãƒ‡ãƒ¼ã‚¿æ§‹é€  (ãƒªã‚¹ãƒˆ)" colour="#a55b80">
                <block type="lists_create_with"></block>
                <block type="lists_length"></block>
                <block type="lists_getIndex"></block>
                <block type="lists_setIndex"></block>
                <block type="lists_append_to"></block>
            </category>
            
            <!-- é–¢æ•° (æ‰‹ç¶šã) ã‚«ãƒ†ã‚´ãƒª (æ¨™æº–æ©Ÿèƒ½) -->
            <category name="é–¢æ•° (ã‚µãƒ–ãƒ«ãƒ¼ãƒãƒ³)" colour="#7b5ba5" custom="PROCEDURE"></category>

            <sep></sep>

            <category name="æ¡ä»¶åˆ†å²ãƒ»æ¯”è¼ƒ" colour="#f1c40f">
                <block type="controls_if"></block>
                <block type="logic_compare"></block>
                <block type="logic_operation"></block>
                <block type="logic_negate"></block>
                <block type="logic_boolean"></block>
            </category>

            <category name="ç¹°ã‚Šè¿”ã—" colour="#5b67a5">
                <block type="controls_repeat_ext"></block>
                <block type="controls_whileUntil"></block>
            </category>

            <category name="ç®—è¡“ãƒ»ä¹±æ•°" colour="#5b80a5">
                <block type="math_number"></block>
                <block type="math_arithmetic"></block>
                <block type="math_single"></block>
                <block type="math_round"></block>
                <block type="random_integer"></block>
            </category>

            <category name="æ–‡å­—åˆ—æ“ä½œ" colour="#5ba58c">
                <block type="text"></block>
                <block type="text_join"></block>
                <block type="text_length"></block>
                <block type="text_charAt"></block>
                <block type="text_print"></block>
            </category>
        </xml>
    </main>

    <!-- ã‚³ãƒ¼ãƒ‰å‡ºåŠ›ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="codeModal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 backdrop-blur-sm bg-gray-900/50">
        <div class="flex flex-col w-full max-w-4xl max-h-[90vh] overflow-hidden rounded-xl shadow-2xl bg-white dark:bg-gray-800 modal-content border border-gray-200 dark:border-gray-700">
            <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="flex items-center justify-between p-5 border-b bg-gray-50 dark:bg-gray-800 border-gray-200 dark:border-gray-700">
                <div class="flex items-center gap-2">
                    <div class="p-1.5 rounded bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-300">
                        <i data-lucide="file-code" class="w-5 h-5"></i>
                    </div>
                    <h2 class="text-lg font-bold text-gray-800 dark:text-white">Botã‚³ãƒ¼ãƒ‰ (Python)</h2>
                </div>
                <button id="closeModalBtn" class="p-1 transition-colors rounded text-gray-400 hover:text-gray-600 hover:bg-gray-200 dark:hover:text-gray-200 dark:hover:bg-gray-700">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒœãƒ‡ã‚£ -->
            <div class="flex-grow p-6 overflow-y-auto bg-white dark:bg-gray-900">
                <div class="mb-6 space-y-3 p-4 rounded-lg border bg-indigo-50 dark:bg-indigo-900/30 border-indigo-100 dark:border-indigo-800">
                    <h3 class="flex items-center gap-2 font-bold text-indigo-800 dark:text-indigo-300">
                        <i data-lucide="info" class="w-4 h-4"></i> å®Ÿè¡Œæ–¹æ³•
                    </h3>
                    <ol class="space-y-1 text-sm list-decimal list-inside text-indigo-700 dark:text-indigo-300">
                        <li>ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’ <code class="px-1 py-0.5 rounded border dark:bg-gray-800 bg-white border-indigo-200 dark:border-indigo-700">bot.py</code> ã¨ã„ã†åå‰ã§ä¿å­˜ã—ã¾ã™ã€‚</li>
                        <li>ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ <code class="px-1 py-0.5 rounded border select-all dark:bg-gray-800 bg-white border-indigo-200 dark:border-indigo-700">pip install discord.py</code> ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚</li>
                        <li><code class="px-1 py-0.5 rounded border select-all dark:bg-gray-800 bg-white border-indigo-200 dark:border-indigo-700">python bot.py</code> ã‚’å®Ÿè¡Œã—ã¦Botã‚’èµ·å‹•ã—ã¾ã™ã€‚</li>
                    </ol>
                </div>

                <div class="relative group">
                    <div class="absolute top-3 right-3 z-10 opacity-0 transition-opacity group-hover:opacity-100">
                        <button id="copyCodeBtn" class="flex items-center gap-1 px-3 py-1.5 text-xs text-white rounded shadow-lg bg-indigo-600 hover:bg-indigo-700 border border-indigo-500">
                            <i data-lucide="copy" class="w-3 h-3"></i> ã‚³ãƒ”ãƒ¼
                        </button>
                    </div>
                    <pre id="codeOutput" class="p-4 text-sm rounded-lg shadow-inner tab-4 bg-[#1e1e1e] text-[#d4d4d4] border border-gray-700"></pre>
                </div>
            </div>
            
            <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ•ãƒƒã‚¿ãƒ¼ -->
            <div class="flex items-center justify-center gap-1 p-3 text-xs text-center text-gray-500 border-t bg-gray-50 dark:bg-gray-800 border-gray-200 dark:border-gray-700">
                <i data-lucide="shield-check" class="w-3 h-3"></i> Tokenã¯Discord Developer Portalã‹ã‚‰å–å¾—ã—ã€ä»–äººã«ã¯æ•™ãˆãªã„ã§ãã ã•ã„ã€‚
            </div>
        </div>
    </div>

    <!-- ã‚«ã‚¹ã‚¿ãƒ JavaScript (Blocklyå®šç¾©ã‚’ãƒ¡ã‚¤ãƒ³ã«) -->
    <script>
        lucide.createIcons();

        let workspace;
        const STORAGE_KEY = 'discord_bot_builder_workspace_public';

        // ===========================================
        // Blocklyç’°å¢ƒè¨­å®šã€ãƒ–ãƒ­ãƒƒã‚¯å®šç¾©ã€ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼å®šç¾©ã‚’ã‚«ãƒ—ã‚»ãƒ«åŒ–
        // ===========================================
        const setupBlocklyEnvironment = () => {
            // --- 0. ãƒ†ãƒ¼ãƒè¨­å®š & æ—¥æœ¬èªåŒ–è¨­å®š (Blocklyä¾å­˜ã®å®šç¾©) ---
            const modernLightTheme = Blockly.Theme.defineTheme('modernLight', {
                'base': Blockly.Themes.Classic,
                'componentStyles': {
                    'workspaceBackgroundColour': '#f3f4f6',
                    'toolboxBackgroundColour': '#f8fafc',
                    'toolboxForegroundColour': '#334155',
                    'flyoutBackgroundColour': '#ffffff',
                    'flyoutForegroundColour': '#334155',
                    'flyoutOpacity': 1,
                    'scrollbarColour': '#cbd5e1',
                    'insertionMarkerColour': '#fff',
                    'insertionMarkerOpacity': 0.3,
                }
            });

            const modernDarkTheme = Blockly.Theme.defineTheme('modernDark', {
                'base': Blockly.Themes.Classic,
                'componentStyles': {
                    'workspaceBackgroundColour': '#111827',
                    'toolboxBackgroundColour': '#1f2937',
                    'toolboxForegroundColour': '#e2e8f0',
                    'flyoutBackgroundColour': '#1f2937',
                    'flyoutForegroundColour': '#e2e8f0',
                    'flyoutOpacity': 1,
                    'scrollbarColour': '#4b5563',
                    'insertionMarkerColour': '#fff',
                    'insertionMarkerOpacity': 0.3,
                },
                'blockStyles': {
                    'hat_blocks': {'colourPrimary': '#a55b80'}
                }
            });

            // Blockly Pythonã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã‚’4ã‚¹ãƒšãƒ¼ã‚¹ã«è¨­å®š (é‡è¦)
            Blockly.Python.INDENT = '    ';
            
            // ===========================================
            // 1. Blockly ã‚«ã‚¹ã‚¿ãƒ ãƒ–ãƒ­ãƒƒã‚¯å®šç¾© (å‰å›ã®å®šç¾©ã‚’ç¶­æŒ)
            // ===========================================

            // --- ã‚¤ãƒ™ãƒ³ãƒˆ ---
            Blockly.Blocks['on_ready'] = {
                init: function() {
                    this.appendDummyInput().appendField("ğŸ BotãŒèµ·å‹•ã—ãŸã¨ã");
                    this.appendStatementInput("DO").setCheck(null).appendField("å®Ÿè¡Œã™ã‚‹å‡¦ç†");
                    this.setColour(30);
                    this.setTooltip("Botã®ãƒ­ã‚°ã‚¤ãƒ³ãŒå®Œäº†ã—ã€æº–å‚™ãŒã§ããŸæ™‚ã«1å›ã ã‘å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚");
                }
            };

            Blockly.Blocks['on_message_create'] = {
                init: function() {
                    this.appendDummyInput().appendField("ğŸ“© ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡ã—ãŸã¨ã");
                    this.appendStatementInput("DO").setCheck(null).appendField("å®Ÿè¡Œã™ã‚‹å‡¦ç†");
                    this.setColour(30);
                    this.setTooltip("èª°ã‹ãŒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ãŸæ™‚ã«å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚");
                }
            };
            
            Blockly.Blocks['get_message_content'] = {
                init: function() {
                    this.appendDummyInput().appendField("å—ä¿¡ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å†…å®¹");
                    this.setOutput(true, "String");
                    this.setColour(30);
                    this.setTooltip("å—ä¿¡ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒ†ã‚­ã‚¹ãƒˆæœ¬æ–‡ã‚’å–å¾—ã—ã¾ã™ã€‚");
                }
            };

            Blockly.Blocks['on_command_executed'] = {
                init: function() {
                    this.appendDummyInput()
                        .appendField("âš¡ ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰ /")
                        .appendField(new Blockly.FieldTextInput("hello"), "COMMAND_NAME")
                        .appendField("ã‚’ä½¿ã‚ã‚ŒãŸã¨ã");
                    this.appendStatementInput("DO").setCheck(null).appendField("å®Ÿè¡Œã™ã‚‹å‡¦ç†");
                    this.setColour(230);
                    this.setTooltip("æŒ‡å®šã—ãŸã‚³ãƒãƒ³ãƒ‰ï¼ˆä¾‹: /helloï¼‰ãŒå®Ÿè¡Œã•ã‚ŒãŸæ™‚ã®å‹•ä½œã‚’ä½œã‚Šã¾ã™ã€‚");
                }
            };
            
            Blockly.Blocks['prefix_command'] = {
                init: function() {
                    this.appendDummyInput()
                        .appendField("ğŸ—£ï¸ ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚³ãƒãƒ³ãƒ‰")
                        .appendField(new Blockly.FieldTextInput("!ping"), "COMMAND_NAME")
                        .appendField("ã‚’å®Ÿè¡Œã—ãŸã¨ã");
                    this.appendStatementInput("DO").setCheck(null).appendField("å®Ÿè¡Œã™ã‚‹å‡¦ç†");
                    this.setColour(230);
                    this.setTooltip("æŒ‡å®šã—ãŸãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚³ãƒãƒ³ãƒ‰ï¼ˆä¾‹: !pingï¼‰ãŒå®Ÿè¡Œã•ã‚ŒãŸæ™‚ã®å‹•ä½œã‚’ä½œã‚Šã¾ã™ã€‚");
                }
            };

            Blockly.Blocks['get_command_arg'] = {
                init: function() {
                    this.appendDummyInput()
                        .appendField("ã‚³ãƒãƒ³ãƒ‰å¼•æ•°")
                        .appendField(new Blockly.FieldTextInput("name"), "ARG_NAME")
                        .appendField("ã®å€¤");
                    this.setOutput(true, ["String", "Number"]);
                    this.setColour(230);
                    this.setTooltip("ã‚³ãƒãƒ³ãƒ‰ã¨ä¸€ç·’ã«é€ã‚‰ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ï¼ˆå¼•æ•°ï¼‰ã‚’å–å¾—ã—ã¾ã™ã€‚");
                }
            };

            // --- æƒ…å ±å–å¾— ---
            Blockly.Blocks['get_user_info'] = {
                init: function() {
                    this.appendDummyInput()
                        .appendField("ğŸ‘¤ å®Ÿè¡Œè€…ã®")
                        .appendField(new Blockly.FieldDropdown([
                            ["ãƒ¦ãƒ¼ã‚¶ãƒ¼ID", "id"],
                            ["åå‰ (ãƒ¦ãƒ¼ã‚¶ãƒ¼å)", "name"],
                            ["è¡¨ç¤ºå (ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ )", "display_name"],
                            ["ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ (<@ID>)", "mention"]
                        ]), "TYPE");
                    this.setOutput(true, "String");
                    this.setColour(260);
                    this.setTooltip("ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ãŸäººã€ã¾ãŸã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ãŸäººã®æƒ…å ±ã‚’å–å¾—ã—ã¾ã™ã€‚");
                }
            };

            Blockly.Blocks['get_channel_info'] = {
                init: function() {
                    this.appendDummyInput()
                        .appendField("ğŸ“º ç¾åœ¨ã®")
                        .appendField(new Blockly.FieldDropdown([
                            ["ãƒãƒ£ãƒ³ãƒãƒ«ID", "id"],
                            ["ãƒãƒ£ãƒ³ãƒãƒ«å", "name"],
                            ["ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ (<#ID>)", "mention"]
                        ]), "TYPE");
                    this.setOutput(true, "String");
                    this.setColour(260);
                    this.setTooltip("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé€ä¿¡ã•ã‚ŒãŸãƒãƒ£ãƒ³ãƒãƒ«ã®æƒ…å ±ã‚’å–å¾—ã—ã¾ã™ã€‚");
                }
            };

            Blockly.Blocks['get_server_info'] = {
                init: function() {
                    this.appendDummyInput()
                        .appendField("ğŸŒ ã‚µãƒ¼ãƒãƒ¼ã®")
                        .appendField(new Blockly.FieldDropdown([
                            ["ã‚µãƒ¼ãƒãƒ¼ID", "id"],
                            ["ã‚µãƒ¼ãƒãƒ¼å", "name"],
                            ["ãƒ¡ãƒ³ãƒãƒ¼æ•°", "member_count"]
                        ]), "TYPE");
                    this.setOutput(true, ["String", "Number"]);
                    this.setColour(260);
                    this.setTooltip("ç¾åœ¨ã®ã‚µãƒ¼ãƒãƒ¼ï¼ˆã‚®ãƒ«ãƒ‰ï¼‰ã®æƒ…å ±ã‚’å–å¾—ã—ã¾ã™ã€‚");
                }
            };

            // --- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ ---
            Blockly.Blocks['reply_message'] = {
                init: function() {
                    this.appendValueInput("MESSAGE").setCheck(["String", "Embed"]).appendField("â†©ï¸ è¿”ä¿¡ã™ã‚‹");
                    this.appendDummyInput()
                        .appendField("è‡ªåˆ†ã ã‘ã«è¡¨ç¤º")
                        .appendField(new Blockly.FieldCheckbox("FALSE"), "EPHEMERAL");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(160);
                    this.setTooltip("ã‚³ãƒãƒ³ãƒ‰ã‚„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å¯¾ã—ã¦è¿”ä¿¡ã‚’ã—ã¾ã™ã€‚ã€Œè‡ªåˆ†ã ã‘ã«è¡¨ç¤ºã€ã¯ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰ã§ã®ã¿æœ‰åŠ¹ã§ã™ã€‚");
                }
            };

            Blockly.Blocks['edit_reply'] = {
                init: function() {
                    this.appendValueInput("MESSAGE").setCheck(["String", "Embed"]).appendField("âœï¸ è¿”ä¿¡ã‚’ç·¨é›†ã™ã‚‹");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(160);
                    this.setTooltip("æ—¢ã«é€ä¿¡ã—ãŸè¿”ä¿¡ã®å†…å®¹ã‚’æ›¸ãæ›ãˆã¾ã™ã€‚");
                }
            };

            Blockly.Blocks['send_channel_message'] = {
                init: function() {
                    this.appendValueInput("CHANNEL_ID").setCheck("String").appendField("#ï¸âƒ£ ãƒãƒ£ãƒ³ãƒãƒ«ID");
                    this.appendValueInput("MESSAGE").setCheck(["String", "Embed"]).appendField("ã«é€ä¿¡");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(160);
                    this.setTooltip("æŒ‡å®šã—ãŸIDã®ãƒãƒ£ãƒ³ãƒãƒ«ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚Šã¾ã™ã€‚");
                }
            };

            Blockly.Blocks['delete_message'] = {
                init: function() { 
                    this.appendDummyInput().appendField("ğŸ—‘ï¸ ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(160);
                    this.setTooltip("å—ä¿¡ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ã—ã¾ã™ï¼ˆBotã«æ¨©é™ãŒå¿…è¦ã§ã™ï¼‰ã€‚");
                }
            };
            
            Blockly.Blocks['purge_messages'] = {
                init: function() {
                    this.appendValueInput("LIMIT").setCheck("Number").appendField("ğŸ—‘ï¸ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¸€æ‹¬å‰Šé™¤ï¼ˆ");
                    this.appendDummyInput().appendField("ä»¶ï¼‰");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(160);
                    this.setTooltip("ç¾åœ¨ã®ãƒãƒ£ãƒ³ãƒãƒ«ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æœ€æ–°ã‹ã‚‰æŒ‡å®šã—ãŸä»¶æ•°ã ã‘å‰Šé™¤ã—ã¾ã™ã€‚");
                }
            };

            Blockly.Blocks['pin_message'] = {
                init: function() {
                    this.appendDummyInput().appendField("ğŸ“Œ ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ”ãƒ³ç•™ã‚");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(160);
                }
            };
            
            Blockly.Blocks['add_reaction'] = {
                init: function() {
                    this.appendValueInput("EMOJI").setCheck("String").appendField("ğŸ‘ ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä»˜ã‘ã‚‹");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(160);
                    this.setTooltip("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«çµµæ–‡å­—ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä»˜ã‘ã¾ã™ã€‚çµµæ–‡å­—ã¯ãã®ã¾ã¾å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: ğŸ‘ï¼‰ã€‚");
                }
            };
            
            Blockly.Blocks['create_thread'] = {
                init: function() {
                    this.appendValueInput("NAME").setCheck("String").appendField("ğŸ§µ ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ä½œæˆï¼ˆåå‰");
                    this.appendDummyInput().appendField("ï¼‰");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(160);
                    this.setTooltip("ç¾åœ¨ã®ãƒãƒ£ãƒ³ãƒãƒ«ã«æ–°ã—ã„ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ä½œæˆã—ã¾ã™ã€‚");
                }
            };

            // --- ãƒãƒ£ãƒ³ãƒãƒ«æ“ä½œ ---
            Blockly.Blocks['create_text_channel'] = {
                init: function() {
                    this.appendValueInput("NAME").setCheck("String").appendField("ğŸ“ ãƒ†ã‚­ã‚¹ãƒˆãƒãƒ£ãƒ³ãƒãƒ«ä½œæˆ");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(340);
                }
            };

            Blockly.Blocks['delete_channel'] = {
                init: function() {
                    this.appendValueInput("CHANNEL_ID").setCheck("String").appendField("ğŸ—‘ï¸ ãƒãƒ£ãƒ³ãƒãƒ«å‰Šé™¤ (ID");
                    this.appendDummyInput().appendField(")");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(340);
                }
            };

            // --- Botè¨­å®š & ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
            Blockly.Blocks['set_bot_status'] = {
                init: function() {
                    this.appendValueInput("STATUS").setCheck("String").appendField("ğŸ® ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’");
                    this.appendDummyInput()
                        .appendField(new Blockly.FieldDropdown([
                            ["ãƒ—ãƒ¬ã‚¤ä¸­", "playing"],
                            ["è¦–è´ä¸­", "watching"],
                            ["å†ç”Ÿä¸­", "listening"],
                        ]), "TYPE")
                        .appendField("ã«ã™ã‚‹");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(260);
                    this.setTooltip("Botã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’è¨­å®šã—ã¾ã™ã€‚");
                }
            };

            Blockly.Blocks['wait_seconds'] = {
                init: function() {
                    this.appendValueInput("SECONDS").setCheck("Number").appendField("â³");
                    this.appendDummyInput().appendField("ç§’å¾…ã¤");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(260);
                    this.setTooltip("æŒ‡å®šã—ãŸç§’æ•°ã ã‘å‡¦ç†ã‚’ä¸€æ™‚åœæ­¢ã—ã¾ã™ã€‚");
                }
            };

            // --- Embed ---
            Blockly.Blocks['create_embed'] = {
                init: function() {
                    this.appendDummyInput().appendField("âœ¨ æ–°ã—ã„åŸ‹ã‚è¾¼ã¿(Embed)ä½œæˆ");
                    this.appendStatementInput("PROPERTIES").setCheck(null);
                    this.setOutput(true, "Embed");
                    this.setColour(100);
                }
            };

            Blockly.Blocks['set_embed_property'] = {
                init: function() {
                    this.appendValueInput("VALUE").setCheck("String")
                        .appendField("è¨­å®šï¼š")
                        .appendField(new Blockly.FieldDropdown([
                            ["ã‚¿ã‚¤ãƒˆãƒ«", "title"],
                            ["èª¬æ˜æ–‡", "description"],
                            ["è‰² (0xHex)", "color"],
                            ["ç”»åƒURL", "image"],
                        ]), "PROPERTY");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(100);
                }
            };

            Blockly.Blocks['add_embed_field'] = {
                init: function() {
                    this.appendValueInput("NAME").setCheck("String").appendField("é …ç›®å");
                    this.appendValueInput("VALUE").setCheck("String").appendField("å†…å®¹");
                    this.appendDummyInput().appendField("æ¨ªä¸¦ã³").appendField(new Blockly.FieldCheckbox("TRUE"), "INLINE");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(100);
                }
            };

            // --- ç®¡ç† ---
            Blockly.Blocks['kick_user'] = {
                init: function() {
                    this.appendValueInput("USER_ID").setCheck("String").appendField("ğŸ‘¢ Kickã™ã‚‹ (ID");
                    this.appendValueInput("REASON").setCheck("String").appendField("ç†ç”±");
                    this.appendDummyInput().appendField(")");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(0);
                    this.setTooltip("ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰è¿½æ”¾ã—ã¾ã™ã€‚");
                }
            };

            Blockly.Blocks['ban_user'] = {
                init: function() {
                    this.appendValueInput("USER_ID").setCheck("String").appendField("ğŸš« BANã™ã‚‹ (ID");
                    this.appendValueInput("REASON").setCheck("String").appendField("ç†ç”±");
                    this.appendDummyInput().appendField(")");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(0);
                    this.setTooltip("ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ°¸ä¹…è¿½æ”¾ã—ã¾ã™ã€‚");
                }
            };

            Blockly.Blocks['timeout_user'] = {
                init: function() {
                    this.appendValueInput("USER_ID").setCheck("String").appendField("ğŸ”‡ ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ (ID");
                    this.appendValueInput("MINUTES").setCheck("Number").appendField("åˆ†");
                    this.appendDummyInput().appendField("é–“)");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(0);
                    this.setTooltip("æŒ‡å®šã—ãŸæ™‚é–“ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç™ºè¨€ã§ããªã„ã‚ˆã†ã«ã—ã¾ã™ã€‚");
                }
            };

            Blockly.Blocks['add_user_role'] = {
                init: function() {
                    this.appendValueInput("USER_ID").setCheck("String").appendField("â• ãƒ­ãƒ¼ãƒ«ä»˜ä¸ (ãƒ¦ãƒ¼ã‚¶ãƒ¼ID");
                    this.appendValueInput("ROLE_ID").setCheck("String").appendField("ãƒ­ãƒ¼ãƒ«ID");
                    this.appendDummyInput().appendField(")");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(0);
                }
            };
            
            Blockly.Blocks['remove_user_role'] = {
                init: function() {
                    this.appendValueInput("USER_ID").setCheck("String").appendField("â– ãƒ­ãƒ¼ãƒ«å‰¥å¥ª (ãƒ¦ãƒ¼ã‚¶ãƒ¼ID");
                    this.appendValueInput("ROLE_ID").setCheck("String").appendField("ãƒ­ãƒ¼ãƒ«ID");
                    this.appendDummyInput().appendField(")");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(0);
                }
            };

            Blockly.Blocks['create_role'] = {
                init: function() {
                    this.appendValueInput("NAME").setCheck("String").appendField("ğŸ”° æ–°è¦ãƒ­ãƒ¼ãƒ«ä½œæˆ (åå‰");
                    this.appendDummyInput().appendField(")");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(0);
                }
            };
            
            Blockly.Blocks['change_nickname'] = {
                init: function() {
                    this.appendValueInput("USER_ID").setCheck("String").appendField("ğŸ·ï¸ ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ å¤‰æ›´ (ID");
                    this.appendValueInput("NAME").setCheck("String").appendField("æ–°ã—ã„åå‰");
                    this.appendDummyInput().appendField(")");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(0);
                }
            };

            // lists_append_to ã¯æ¨™æº–ãƒ–ãƒ­ãƒƒã‚¯ã«ãªã„ãŸã‚ã€ã“ã“ã§å®šç¾©
            Blockly.Blocks['lists_append_to'] = {
                init: function() {
                    this.appendValueInput('LIST').setCheck('Array').appendField('ãƒªã‚¹ãƒˆ');
                    this.appendValueInput('ITEM').setCheck(null).appendField('ã«é …ç›®');
                    this.appendDummyInput().appendField('ã‚’è¿½åŠ ');
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour(210);
                }
            };
                
            // ===========================================
            // 2. Python (discord.py) Generator Definitions
            // ===========================================

            // StatementToCodeã«ç©ºã®ã‚³ãƒ¼ãƒ‰ãŒè¿”ã•ã‚ŒãŸå ´åˆã€Pythonã®ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã‚¨ãƒ©ãƒ¼ã‚’é¿ã‘ã‚‹ãŸã‚ã« 'pass' ã‚’è¿½åŠ ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
            const getBranchCode = (block, name) => {
                let code = Blockly.Python.statementToCode(block, name);
                if (code.trim() === '') {
                    // statementToCodeãŒè¿”ã™ã‚³ãƒ¼ãƒ‰ã¯æ—¢ã«ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã•ã‚Œã¦ã„ã‚‹
                    return Blockly.Python.INDENT + 'pass\n';
                }
                return code;
            };

            // èµ·å‹•æ™‚ (on_ready)
            Blockly.Python['on_ready'] = function(block) {
                const branch = getBranchCode(block, 'DO');
                return `
@bot.event
async def on_ready():
    # Botèµ·å‹•æ™‚ã®ãƒ­ã‚°å‡ºåŠ›ã¨ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰ã®åŒæœŸ
    print(f'Logged in as {bot.user}')
    try:
        synced = await bot.tree.sync()
        print(f"Synced {len(synced)} command(s)")
    except Exception as e:
        print(e)
    
    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½œæˆã—ãŸãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè¡Œ
${branch.trimEnd()}
`;
            };

            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡ (on_message_create)
            Blockly.Python['on_message_create'] = function(block) {
                const branch = getBranchCode(block, 'DO');
                return `
@bot.event
async def on_message(message):
    if message.author == bot.user:
        return
    # ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå¤‰æ•°ã¨ã—ã¦ message ã¨ ctx, user ã‚’æä¾›
    ctx = message
    user = message.author
    
    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½œæˆã—ãŸãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè¡Œ
${branch.trimEnd()}
    
    # ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚³ãƒãƒ³ãƒ‰ã®å‡¦ç†ã‚’ç¶šè¡Œ
    await bot.process_commands(message)
`;
            };

            Blockly.Python['get_message_content'] = function(block) {
                return ['ctx.content', Blockly.Python.ORDER_ATOMIC];
            };

            // ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰ (on_command_executed)
            Blockly.Python['on_command_executed'] = function(block) {
                const commandName = block.getFieldValue('COMMAND_NAME').toLowerCase();
                const branch = getBranchCode(block, 'DO');
                return `
@bot.tree.command(name="${commandName}", description="${commandName} command")
async def ${commandName}_cmd(interaction: discord.Interaction):
    # ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå¤‰æ•°ã¨ã—ã¦ interaction ã¨ ctx, user ã‚’æä¾›
    ctx = interaction
    user = interaction.user
    
    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½œæˆã—ãŸãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè¡Œ
${branch.trimEnd()}
`;
            };
            
            // ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚³ãƒãƒ³ãƒ‰ (prefix_command)
            Blockly.Python['prefix_command'] = function(block) {
                const commandName = block.getFieldValue('COMMAND_NAME').replace(/^[!~#&?]/, '');
                const branch = getBranchCode(block, 'DO');
                return `
@bot.command(name='${commandName}')
async def ${commandName}_cmd(ctx):
    # ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå¤‰æ•°ã¨ã—ã¦ ctx, user ã‚’æä¾›
    user = ctx.author
    
    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½œæˆã—ãŸãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè¡Œ
${branch.trimEnd()}
`;
            };

            Blockly.Python['get_command_arg'] = function(block) {
                const argName = block.getFieldValue('ARG_NAME');
                return [`# å¼•æ•°ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼: ${argName} (é–¢æ•°å®šç¾©ã§å¼•æ•°ã‚’è¿½åŠ ã—ã¦ãã ã•ã„)`, Blockly.Python.ORDER_ATOMIC];
            };

            // --- æƒ…å ±å–å¾—, ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¢ã‚¯ã‚·ãƒ§ãƒ³, ãƒãƒ£ãƒ³ãƒãƒ«æ“ä½œ, Botè¨­å®š, Embed, ç®¡ç†æ©Ÿèƒ½ ---
            // (å‰å›ã¨åŒã˜ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’ä¿æŒ)
            Blockly.Python['get_user_info'] = function(block) {
                const type = block.getFieldValue('TYPE');
                let code = `user.${type}`;
                if (type === 'name') code = 'user.name';
                if (type === 'display_name') code = 'user.display_name';
                return [code, Blockly.Python.ORDER_ATOMIC];
            };

            Blockly.Python['get_channel_info'] = function(block) {
                const type = block.getFieldValue('TYPE');
                let code = `ctx.channel.${type}`;
                return [code, Blockly.Python.ORDER_ATOMIC];
            };

            Blockly.Python['get_server_info'] = function(block) {
                const type = block.getFieldValue('TYPE');
                let code = `ctx.guild.${type}`;
                return [code, Blockly.Python.ORDER_ATOMIC];
            };
            
            Blockly.Python['reply_message'] = function(block) {
                const msg = Blockly.Python.valueToCode(block, 'MESSAGE', Blockly.Python.ORDER_NONE) || '""';
                const ephemeral = block.getFieldValue('EPHEMERAL') === 'TRUE' ? 'True' : 'False';
                let contentCode = msg.startsWith('discord.Embed') ? `embed=${msg}` : `content=${msg}`;
                const code = `
if isinstance(ctx, discord.Interaction):
    if ctx.response.is_done():
        await ctx.followup.send(${contentCode}, ephemeral=${ephemeral})
    else:
        await ctx.response.send_message(${contentCode}, ephemeral=${ephemeral})
elif isinstance(ctx, commands.Context):
    await ctx.send(${contentCode})
elif 'message' in locals() and isinstance(ctx, discord.Message):
    await ctx.reply(${contentCode})
`;
                return code + '\n';
            };

            Blockly.Python['edit_reply'] = function(block) {
                const msg = Blockly.Python.valueToCode(block, 'MESSAGE', Blockly.Python.ORDER_NONE) || '""';
                let contentCode = msg.startsWith('discord.Embed') ? `embed=${msg}` : `content=${msg}`;
                const code = `
if isinstance(ctx, discord.Interaction):
    await ctx.edit_original_response(${contentCode})
else:
    pass
`;
                return code + '\n';
            };

            Blockly.Python['send_channel_message'] = function(block) {
                const channelId = Blockly.Python.valueToCode(block, 'CHANNEL_ID', Blockly.Python.ORDER_NONE) || '""';
                const msg = Blockly.Python.valueToCode(block, 'MESSAGE', Blockly.Python.ORDER_NONE) || '""';
                const contentArg = msg.startsWith('discord.Embed') ? `embed=${msg}` : `content=${msg}`;
                const code = `
channel_id = int(${channelId})
channel = bot.get_channel(channel_id)
if channel:
    await channel.send(${contentArg})
`;
                return code + '\n';
            };

            Blockly.Python['delete_message'] = function(block) {
                const code = `
if 'message' in locals() and isinstance(ctx, discord.Message):
    await ctx.delete()
elif isinstance(ctx, commands.Context):
    await ctx.message.delete()
else:
    pass
`;
                return code + '\n';
            };
            
            Blockly.Python['purge_messages'] = function(block) {
                const limit = Blockly.Python.valueToCode(block, 'LIMIT', Blockly.Python.ORDER_NONE) || '5';
                const code = `
if ctx.channel:
    await ctx.channel.purge(limit=int(${limit}))
`;
                return code + '\n';
            };

            Blockly.Python['pin_message'] = function(block) {
                const code = `
if 'message' in locals() and isinstance(ctx, discord.Message):
    await ctx.pin()
elif isinstance(ctx, commands.Context):
    await ctx.message.pin()
`;
                return code + '\n';
            };
            
            Blockly.Python['add_reaction'] = function(block) {
                const emoji = Blockly.Python.valueToCode(block, 'EMOJI', Blockly.Python.ORDER_NONE) || '"ğŸ‘"';
                const code = `
try:
    if 'message' in locals() and isinstance(ctx, discord.Message): 
        await ctx.add_reaction(${emoji})
    elif isinstance(ctx, commands.Context): 
        await ctx.message.add_reaction(${emoji})
except Exception as e:
    print(f"Failed to add reaction: {e}")
`;
                return code + '\n';
            };
            
            Blockly.Python['create_thread'] = function(block) {
                const name = Blockly.Python.valueToCode(block, 'NAME', Blockly.Python.ORDER_NONE) || '"New Thread"';
                const code = `
try:
    if 'message' in locals() and isinstance(ctx, discord.Message): 
        await ctx.message.create_thread(name=${name})
    elif isinstance(ctx, commands.Context): 
        await ctx.message.create_thread(name=${name})
except Exception as e:
    print(f"Failed to create thread: {e}")
`;
                return code + '\n';
            };

            Blockly.Python['create_text_channel'] = function(block) {
                const name = Blockly.Python.valueToCode(block, 'NAME', Blockly.Python.ORDER_NONE) || '"new-channel"';
                const code = `
if ctx.guild:
    await ctx.guild.create_text_channel(name=${name})
`;
                return code + '\n';
            };

            Blockly.Python['delete_channel'] = function(block) {
                const channelId = Blockly.Python.valueToCode(block, 'CHANNEL_ID', Blockly.Python.ORDER_NONE);
                const code = `
ch = bot.get_channel(int(${channelId}))
if ch:
    await ch.delete()
`;
                return code + '\n';
            };

            Blockly.Python['set_bot_status'] = function(block) {
                const status = Blockly.Python.valueToCode(block, 'STATUS', Blockly.Python.ORDER_NONE) || '"Bot"';
                const type = block.getFieldValue('TYPE');
                let activityCode = `discord.Game(name=${status})`;
                if (type === 'watching') activityCode = `discord.Activity(type=discord.ActivityType.watching, name=${status})`;
                if (type === 'listening') activityCode = `discord.Activity(type=discord.ActivityType.listening, name=${status})`;
                return `await bot.change_presence(activity=${activityCode})\n`;
            };

            Blockly.Python['wait_seconds'] = function(block) {
                const sec = Blockly.Python.valueToCode(block, 'SECONDS', Blockly.Python.ORDER_NONE) || '1';
                return `await asyncio.sleep(${sec})\n`;
            };

            Blockly.Python['create_embed'] = function(block) {
                const embedVarName = Blockly.Python.variableDB_.get(Blockly.Names.createValidName('embed', Blockly.Names.NAME_TYPE));
                let code = `
# åŸ‹ã‚è¾¼ã¿ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ§‹ç¯‰ã‚’é–‹å§‹
${embedVarName} = discord.Embed(title="New Embed", description="èª¬æ˜æ–‡ã‚’è¨­å®šã—ã¦ãã ã•ã„", color=0x3498DB)
                `.trim() + '\n';
                const propertiesCode = Blockly.Python.statementToCode(block, 'PROPERTIES');
                const lines = propertiesCode.split('\n').filter(line => line.trim() !== '');
                const fieldCode = [];
                
                for (const line of lines) {
                    if (line.includes('add_field')) {
                        fieldCode.push(line.replace(/# EMBED_VAR_PLACEHOLDER/g, embedVarName).trim());
                    } else if (line.trim().startsWith('embed.')) {
                        code += line.trim().replace(/embed\./g, `${embedVarName}.`) + '\n';
                    }
                }
                if (fieldCode.length > 0) {
                    code += '\n' + fieldCode.join('\n') + '\n';
                }
                return [`${embedVarName}`, Blockly.Python.ORDER_ATOMIC];
            };
            
            Blockly.Python['set_embed_property'] = function(block) {
                const property = block.getFieldValue('PROPERTY');
                const value = Blockly.Python.valueToCode(block, 'VALUE', Blockly.Python.ORDER_NONE) || '""';
                if (property === 'color') {
                    return 'embed.color = ' + value + '\n';
                } else if (property === 'image') {
                    return 'embed.set_image(url=' + value + ')\n';
                } else if (property === 'title') {
                    return 'embed.title = ' + value + '\n';
                } else if (property === 'description') {
                    return 'embed.description = ' + value + '\n';
                }
                return '';
            };
            
            Blockly.Python['add_embed_field'] = function(block) {
                const name = Blockly.Python.valueToCode(block, 'NAME', Blockly.Python.ORDER_NONE) || '""';
                const value = Blockly.Python.valueToCode(block, 'VALUE', Blockly.Python.ORDER_NONE) || '""';
                const inline = block.getFieldValue('INLINE') === 'TRUE' ? 'True' : 'False';
                return `# EMBED_VAR_PLACEHOLDER.add_field(name=${name}, value=${value}, inline=${inline})\n`;
            };

            Blockly.Python['kick_user'] = function(block) {
                const user = Blockly.Python.valueToCode(block, 'USER_ID', Blockly.Python.ORDER_NONE);
                const reason = Blockly.Python.valueToCode(block, 'REASON', Blockly.Python.ORDER_NONE) || 'None';
                const code = `
member = ctx.guild.get_member(int(${user}))
if member:
    await member.kick(reason=${reason})
`;
                return code + '\n';
            };
            
            Blockly.Python['ban_user'] = function(block) {
                const user = Blockly.Python.valueToCode(block, 'USER_ID', Blockly.Python.ORDER_NONE);
                const reason = Blockly.Python.valueToCode(block, 'REASON', Blockly.Python.ORDER_NONE) || 'None';
                const code = `
member = ctx.guild.get_member(int(${user}))
if member:
    await member.ban(reason=${reason})
`;
                return code + '\n';
            };
            
            Blockly.Python['timeout_user'] = function(block) {
                const user = Blockly.Python.valueToCode(block, 'USER_ID', Blockly.Python.ORDER_NONE);
                const mins = Blockly.Python.valueToCode(block, 'MINUTES', Blockly.Python.ORDER_NONE) || '5';
                const code = `
member = ctx.guild.get_member(int(${user}))
if member:
    duration = datetime.timedelta(minutes=int(${mins}))
    await member.timeout(duration)
`;
                return code + '\n';
            };

            Blockly.Python['add_user_role'] = function(block) {
                const user = Blockly.Python.valueToCode(block, 'USER_ID', Blockly.Python.ORDER_NONE);
                const role = Blockly.Python.valueToCode(block, 'ROLE_ID', Blockly.Python.ORDER_NONE);
                const code = `
member = ctx.guild.get_member(int(${user}))
role = ctx.guild.get_role(int(${role}))
if member and role:
    await member.add_roles(role)
`;
                return code + '\n';
            };

            Blockly.Python['remove_user_role'] = function(block) {
                const user = Blockly.Python.valueToCode(block, 'USER_ID', Blockly.Python.ORDER_NONE);
                const role = Blockly.Python.valueToCode(block, 'ROLE_ID', Blockly.Python.ORDER_NONE);
                const code = `
member = ctx.guild.get_member(int(${user}))
role = ctx.guild.get_role(int(${role}))
if member and role:
    await member.remove_roles(role)
`;
                return code + '\n';
            };

            Blockly.Python['create_role'] = function(block) {
                const name = Blockly.Python.valueToCode(block, 'NAME', Blockly.Python.ORDER_NONE);
                const code = `
if ctx.guild:
    await ctx.guild.create_role(name=${name})
`;
                return code + '\n';
            };
            
            Blockly.Python['change_nickname'] = function(block) {
                const user = Blockly.Python.valueToCode(block, 'USER_ID', Blockly.Python.ORDER_NONE);
                const name = Blockly.Python.valueToCode(block, 'NAME', Blockly.Python.ORDER_NONE);
                const code = `
member = ctx.guild.get_member(int(${user}))
if member:
    await member.edit(nick=${name})
`;
                return code + '\n';
            };

            // --- é–¢æ•° (æ‰‹ç¶šã) ãƒ–ãƒ­ãƒƒã‚¯ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ (éåŒæœŸåŒ–) ---
            Blockly.Python['procedures_defnoreturn'] = Blockly.Python['procedures_defreturn'] = function(block) {
                const funcName = Blockly.Python.variableDB_.getName(block.getFieldValue('NAME'), Blockly.Names.PROCEDURE_NAME);
                const branch = getBranchCode(block, 'STACK');
                
                let args = [];
                for (let i = 0; i < block.arguments_.length; i++) {
                    args.push(Blockly.Python.variableDB_.getName(block.arguments_[i], Blockly.Names.VARIABLE_NAME));
                }
                const argsString = args.join(', ');

                let returnValue = Blockly.Python.valueToCode(block, 'RETURN', Blockly.Python.ORDER_NONE) || '';
                let returnCode = '';
                if (block.type === 'procedures_defreturn' && returnValue) {
                    returnCode = `${Blockly.Python.INDENT}return ${returnValue}\n`;
                }

                const code = `
# ãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©ã®éåŒæœŸé–¢æ•°
async def ${funcName}(${argsString}):
${branch.trimEnd()}
${returnCode.trimEnd()}
`;
                return code + '\n';
            };

            Blockly.Python['procedures_callnoreturn'] = function(block) {
                const funcName = Blockly.Python.variableDB_.getName(block.getFieldValue('NAME'), Blockly.Names.PROCEDURE_NAME);
                const args = [];
                for (let i = 0; i < block.arguments_.length; i++) {
                    args.push(Blockly.Python.valueToCode(block, 'ARG' + i, Blockly.Python.ORDER_NONE) || 'None');
                }
                const argsString = args.join(', ');
                return `await ${funcName}(${argsString})\n`;
            };

            Blockly.Python['procedures_callreturn'] = function(block) {
                const funcName = Blockly.Python.variableDB_.getName(block.getFieldValue('NAME'), Blockly.Names.PROCEDURE_NAME);
                const args = [];
                for (let i = 0; i < block.arguments_.length; i++) {
                    args.push(Blockly.Python.valueToCode(block, 'ARG' + i, Blockly.Python.ORDER_NONE) || 'None');
                }
                const argsString = args.join(', ');
                return [`await ${funcName}(${argsString})`, Blockly.Python.ORDER_FUNCTION_CALL];
            };

            // --- ãƒªã‚¹ãƒˆæ“ä½œãƒ–ãƒ­ãƒƒã‚¯ã®ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼å®šç¾© (ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒã‚°ä¿®æ­£) ---
            
            // lists_create_with: æ¨™æº–ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’æ˜ç¤ºçš„ã«å®šç¾©
            Blockly.Python['lists_create_with'] = function(block) {
                const elements = [];
                for (let i = 0; i < block.itemCount_; i++) {
                    elements.push(Blockly.Python.valueToCode(block, 'ADD' + i, Blockly.Python.ORDER_NONE) || 'None');
                }
                const code = '[' + elements.join(', ') + ']';
                return [code, Blockly.Python.ORDER_ATOMIC];
            };
            
            // lists_length: æ¨™æº–ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’æ˜ç¤ºçš„ã«å®šç¾©
            Blockly.Python['lists_length'] = function(block) {
                const list = Blockly.Python.valueToCode(block, 'VALUE', Blockly.Python.ORDER_NONE) || '[]';
                return [`len(${list})`, Blockly.Python.ORDER_FUNCTION_CALL];
            };
            
            // lists_append_to: ã‚«ã‚¹ã‚¿ãƒ ãƒ–ãƒ­ãƒƒã‚¯ã®ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼
            Blockly.Python['lists_append_to'] = function(block) {
                const list = Blockly.Python.valueToCode(block, 'LIST', Blockly.Python.ORDER_MEMBER) || '[]';
                const item = Blockly.Python.valueToCode(block, 'ITEM', Blockly.Python.ORDER_NONE) || 'None';
                return `${list}.append(${item})\n`;
            };

            // lists_getIndex: 1-based to 0-based indexingä¿®æ­£
            Blockly.Python['lists_getIndex'] = function(block) {
                const mode = block.getFieldValue('MODE') || 'GET';
                const where = block.getFieldValue('WHERE') || 'FROM_START';
                const list = Blockly.Python.valueToCode(block, 'VALUE', Blockly.Python.ORDER_MEMBER) || '[]';
                
                let code, at;

                if (where === 'FROM_START') {
                    // Pythonã®0-basedã«å¯¾å¿œã™ã‚‹ãŸã‚ã€Blocklyã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‹ã‚‰1ã‚’å¼•ã
                    at = Blockly.Python.valueToCode(block, 'AT', Blockly.Python.ORDER_ADDITIVE) || '1';
                    at = Blockly.isNumber(at) ? parseInt(at, 10) - 1 : `(int(${at}) - 1)`;
                    
                    if (mode === 'GET') {
                        code = `${list}[${at}]`;
                    } else if (mode === 'GET_REMOVE') {
                        code = `${list}.pop(${at})`;
                    } else if (mode === 'REMOVE') {
                        code = `del ${list}[${at}]\n`;
                    }
                } else if (where === 'FROM_END') {
                    // Pythonã®è² ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«å¯¾å¿œã€‚FROM_END 1ã¯-1ã€FROM_END 2ã¯-2
                    at = Blockly.Python.valueToCode(block, 'AT', Blockly.Python.ORDER_UNARY_SIGN) || '1';
                    at = Blockly.isNumber(at) ? -parseInt(at, 10) : `-int(${at})`;
                    
                    if (mode === 'GET') {
                        code = `${list}[${at}]`;
                    } else if (mode === 'GET_REMOVE') {
                        code = `${list}.pop(${at})`;
                    } else if (mode === 'REMOVE') {
                        code = `del ${list}[${at}]\n`;
                    }
                } else if (where === 'FIRST') {
                    if (mode === 'GET') code = `${list}[0]`;
                    else if (mode === 'GET_REMOVE') code = `${list}.pop(0)`;
                    else if (mode === 'REMOVE') code = `del ${list}[0]\n`;
                } else if (where === 'LAST') {
                    if (mode === 'GET') code = `${list}[-1]`;
                    else if (mode === 'GET_REMOVE') code = `${list}.pop()`;
                    else if (mode === 'REMOVE') code = `del ${list}[-1]\n`;
                } else {
                     // RANDOM ãªã©ã€ãã®ä»–ã®ãƒ¢ãƒ¼ãƒ‰ã¯æ¨™æº–ã®ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ã«ä¾å­˜
                     return Blockly.Python.lists_getIndex(block);
                }

                if (mode === 'REMOVE') {
                    return code;
                }
                return [code, Blockly.Python.ORDER_MEMBER];
            };


            // lists_setIndex: 1-based to 0-based indexingä¿®æ­£
            Blockly.Python['lists_setIndex'] = function(block) {
                const mode = block.getFieldValue('MODE') || 'SET';
                const where = block.getFieldValue('WHERE') || 'FROM_START';
                const list = Blockly.Python.valueToCode(block, 'LIST', Blockly.Python.ORDER_MEMBER) || '[]';
                const value = Blockly.Python.valueToCode(block, 'VALUE', Blockly.Python.ORDER_NONE) || 'None';
                
                let code, at;
                
                if (where === 'FROM_START') {
                    at = Blockly.Python.valueToCode(block, 'AT', Blockly.Python.ORDER_ADDITIVE) || '1';
                    at = Blockly.isNumber(at) ? parseInt(at, 10) - 1 : `(int(${at}) - 1)`;

                    if (mode === 'SET') {
                        code = `${list}[${at}] = ${value}\n`;
                    } else if (mode === 'INSERT') {
                        code = `${list}.insert(${at}, ${value})\n`;
                    }
                } else if (where === 'FIRST') {
                    if (mode === 'SET') code = `${list}[0] = ${value}\n`;
                    else if (mode === 'INSERT') code = `${list}.insert(0, ${value})\n`;
                } else if (where === 'LAST') {
                    if (mode === 'SET') code = `${list}[-1] = ${value}\n`;
                    else if (mode === 'INSERT') code = `${list}.append(${value})\n`; 
                } else if (where === 'FROM_END') {
                    at = Blockly.Python.valueToCode(block, 'AT', Blockly.Python.ORDER_UNARY_SIGN) || '1';
                    
                    if (mode === 'SET') {
                        // SET FROM_END n ã¯ Python ã® -n ã¨ç­‰ã—ã„
                        const setAt = Blockly.isNumber(at) ? -parseInt(at, 10) : `-int(${at})`;
                        code = `${list}[${setAt}] = ${value}\n`;
                    } else if (mode === 'INSERT') {
                        // INSERT FROM_END n ã¯ Python ã® insert(len(list) - n, value) ã¨ç­‰ã—ã„
                        const insertAt = Blockly.isNumber(at) ? `len(${list}) - ${parseInt(at, 10)}` : `len(${list}) - int(${at})`;
                        code = `${list}.insert(${insertAt}, ${value})\n`;
                    }
                } else {
                    // RANDOM, etc. ã¯æ¨™æº–ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ã«ä¾å­˜ã€‚
                    return Blockly.Python.lists_setIndex(block);
                }
                
                return code;
            };
            
            // --- æ•°å€¤ãƒ»è¨ˆç®—ãƒ–ãƒ­ãƒƒã‚¯ã®ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼å®šç¾© (æ¨™æº–ã«æˆ»ã™) ---
            // math_number, math_arithmetic, math_single, math_round ã¯æ¨™æº–ã®Pythonã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’ä½¿ç”¨ã—ã€
            // Blockly.Python.provideFunction ã§å¿…è¦ãª import ã‚’ç¢ºå®Ÿã«è¿½åŠ ã•ã›ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
            
            Blockly.Python['math_number'] = Blockly.Python.math_number;
            Blockly.Python['math_arithmetic'] = Blockly.Python.math_arithmetic;

            // math_single (ABS, ROOT, NEG, TRIGONOMETRY)
            Blockly.Python['math_single'] = function(block) {
                // æ¨™æº–ã®ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’å‘¼ã³å‡ºã—ã€å¿…è¦ãª 'math' import ã‚’è‡ªå‹•ã§å‡¦ç†ã•ã›ã‚‹
                return Blockly.Python.math_single(block);
            };

            // math_round (ROUND, ROUNDUP, ROUNDDOWN)
            Blockly.Python['math_round'] = function(block) {
                // æ¨™æº–ã®ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’å‘¼ã³å‡ºã—ã€å¿…è¦ãª 'math' import ã‚’è‡ªå‹•ã§å‡¦ç†ã•ã›ã‚‹
                return Blockly.Python.math_round(block);
            };

            // random_integer: ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ã®å†å®šç¾©
            Blockly.Python['random_integer'] = function(block) {
                const from = Blockly.Python.valueToCode(block, 'FROM', Blockly.Python.ORDER_NONE) || '0';
                const to = Blockly.Python.valueToCode(block, 'TO', Blockly.Python.ORDER_NONE) || '100';
                // æ¨™æº–ã® randint é–¢æ•°ã«ä¾å­˜
                return [`random.randint(int(${from}), int(${to}))`, Blockly.Python.ORDER_ATOMIC];
            };

            // text_charAt: æ¨™æº–ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’æ˜ç¤ºçš„ã«å®šç¾© (æ–‡å­—åˆ—ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚‚0-basedä¿®æ­£ãŒå¿…è¦)
            Blockly.Python['text_charAt'] = function(block) {
                const where = block.getFieldValue('WHERE') || 'FROM_START';
                const text = Blockly.Python.valueToCode(block, 'VALUE', Blockly.Python.ORDER_MEMBER) || "''";
                let code;
                let at;

                if (where === 'FROM_START') {
                    at = Blockly.Python.valueToCode(block, 'AT', Blockly.Python.ORDER_ADDITIVE) || '1';
                    at = Blockly.isNumber(at) ? parseInt(at, 10) - 1 : `(int(${at}) - 1)`;
                    code = `${text}[${at}]`;
                } else if (where === 'FIRST') {
                    code = `${text}[0]`;
                } else if (where === 'LAST') {
                    code = `${text}[-1]`;
                } else {
                    // FROM_ENDã‚„RANDOMã¯æ¨™æº–ã«ä¾å­˜
                    return Blockly.Python.text_charAt(block);
                }
                
                return [code, Blockly.Python.ORDER_MEMBER];
            };
            
            // --- æ¨™æº–ãƒ­ã‚¸ãƒƒã‚¯ã®èª¿æ•´ (ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆå‡¦ç†ã®ä¿®æ­£) ---
            Blockly.Python['controls_if'] = function(block) {
                let code = '';
                let condition = Blockly.Python.valueToCode(block, 'IF0', Blockly.Python.ORDER_NONE) || 'False';
                let branchCode = getBranchCode(block, 'DO0');
                code += `if ${condition}:\n${branchCode}`;

                for (let i = 1; i <= block.elseifCount_; i++) {
                    condition = Blockly.Python.valueToCode(block, 'IF' + i, Blockly.Python.ORDER_NONE) || 'False';
                    branchCode = getBranchCode(block, 'DO' + i);
                    code += `elif ${condition}:\n${branchCode}`;
                }
                
                if (block.elseCount_) {
                    branchCode = getBranchCode(block, 'ELSE');
                    code += `else:\n${branchCode}`;
                }
                return code;
            };

            return { modernLightTheme, modernDarkTheme };
        };
        
        // ===========================================
        // 3. App Initialization (DOMä¾å­˜ã®ãƒ­ã‚¸ãƒƒã‚¯)
        // ===========================================

        const html = document.documentElement;

        const toggleTheme = (modernLightTheme, modernDarkTheme) => {
            const currentTheme = html.classList.contains('dark') ? 'dark' : 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';

            html.classList.remove(currentTheme);
            html.classList.add(newTheme);
            localStorage.setItem('theme', newTheme);
            
            if (workspace) {
                const theme = newTheme === 'dark' ? modernDarkTheme : modernLightTheme;
                workspace.setTheme(theme);
            }
        };

        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            html.classList.add('dark');
        } else {
            html.classList.add('light');
        }

        const saveToLocal = () => {
            if (!workspace) return;
            const xml = Blockly.Xml.workspaceToDom(workspace);
            const xmlText = Blockly.Xml.domToText(xml);
            localStorage.setItem(STORAGE_KEY, xmlText);
            
            const saveStatus = document.getElementById('saveStatus');
            saveStatus.style.opacity = '1';
            setTimeout(() => saveStatus.style.opacity = '0', 2000);
        };

        const loadFromLocal = () => {
            const xmlText = localStorage.getItem(STORAGE_KEY);
            if (xmlText && workspace) {
                try {
                    const xml = Blockly.Xml.textToDom(xmlText);
                    Blockly.Xml.clearWorkspaceAndLoadFromXml(xml, workspace);
                } catch (e) {
                    console.error("Failed to load workspace from local storage:", e);
                }
            }
        };

        const generatePythonCode = () => {
            let rawCode = Blockly.Python.workspaceToCode(workspace);
            
            const rootIndent = Blockly.Python.INDENT;
            let cleanedCode = rawCode.split('\n')
                .map(line => {
                    if (line.startsWith(rootIndent)) {
                        return line.substring(rootIndent.length);
                    }
                    return line;
                })
                .join('\n')
                .trim();


            const commandPrefix = '!'; 

            const boilerplate = `
# å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
import discord
from discord import app_commands
from discord.ext import commands
import random
import asyncio
import datetime
import math # æ•°å­¦æ¼”ç®—ãƒ–ãƒ­ãƒƒã‚¯ã®ãŸã‚ã«å¿…è¦

# ã‚¤ãƒ³ãƒ†ãƒ³ãƒˆã®è¨­å®šï¼ˆBotã®æ¨©é™è¨­å®šï¼‰
# 'message_content' ã¨ 'members' ã¯Discord Developer Portalã‹ã‚‰æœ‰åŠ¹åŒ–ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
intents = discord.Intents.default()
intents.message_content = True 
intents.members = True 

# Botã®ä½œæˆ (ã“ã“ã§ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’æŒ‡å®š)
bot = commands.Bot(command_prefix='${commandPrefix}', intents=intents)

# --- ä½œæˆã—ãŸãƒ–ãƒ­ãƒƒã‚¯ã®ãƒ­ã‚¸ãƒƒã‚¯ ---
${cleanedCode}
# -------------------------------

# Botã®èµ·å‹•
# æ³¨æ„: Bot Tokenã¯ä»–äººã«æ•™ãˆãªã„ã§ãã ã•ã„
bot.run('YOUR_BOT_TOKEN_HERE')
`;
            return boilerplate.trim();
        };

        const initializeApp = () => {
            const { modernLightTheme, modernDarkTheme } = setupBlocklyEnvironment();

            const blocklyDiv = document.getElementById('blocklyDiv');
            const toolbox = document.getElementById('toolbox');
            const themeToggle = document.getElementById('themeToggle');
            const showCodeBtn = document.getElementById('showCodeBtn');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const copyCodeBtn = document.getElementById('copyCodeBtn');
            const codeModal = document.getElementById('codeModal');
            const codeOutput = document.getElementById('codeOutput');
            const importBtn = document.getElementById('importBtn');
            const exportBtn = document.getElementById('exportBtn');
            const importInput = document.getElementById('importInput');
            
            const initialTheme = savedTheme === 'dark' ? modernDarkTheme : modernLightTheme;

            workspace = Blockly.inject(blocklyDiv, {
                toolbox: toolbox,
                horizontalLayout: false,
                trashcan: true,
                zoom: { controls: true, wheel: true, startScale: 1.0, maxScale: 3, minScale: 0.3, scaleSpeed: 1.2 },
                renderer: 'zelos',
                theme: initialTheme
            });

            loadFromLocal();

            workspace.addChangeListener((e) => {
                if (e.isUiEvent || e.type === Blockly.Events.FINISHED_LOADING) return;
                saveToLocal();
            });

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            themeToggle.addEventListener('click', () => toggleTheme(modernLightTheme, modernDarkTheme));
            
            importBtn.addEventListener('click', () => importInput.click());
            importInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const xml = Blockly.Xml.textToDom(e.target.result);
                        Blockly.Xml.clearWorkspaceAndLoadFromXml(xml, workspace);
                        saveToLocal();
                    } catch (err) {
                        console.error('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', err);
                    }
                };
                reader.readAsText(file);
                e.target.value = '';
            });

            exportBtn.addEventListener('click', () => {
                if (!workspace) return;
                const xml = Blockly.Xml.workspaceToDom(workspace);
                const xmlText = Blockly.Xml.domToText(xml);
                const blob = new Blob([xmlText], {type: 'text/xml'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `bot-project-${new Date().toISOString().slice(0,10)}.xml`;
                a.click();
                URL.revokeObjectURL(url);
            });


            showCodeBtn.addEventListener('click', () => {
                codeOutput.textContent = generatePythonCode();
                codeModal.classList.remove('hidden');
                codeModal.classList.add('flex');
                setTimeout(() => codeModal.classList.add('show-modal'), 10);
            });

            closeModalBtn.addEventListener('click', () => {
                codeModal.classList.remove('show-modal');
                setTimeout(() => {
                    codeModal.classList.remove('flex');
                    codeModal.classList.add('hidden');
                }, 200);
            });
            
            copyCodeBtn.addEventListener('click', () => {
                navigator.clipboard.writeText(codeOutput.textContent).then(() => {
                    const originalText = copyCodeBtn.innerHTML;
                    copyCodeBtn.innerHTML = '<i data-lucide="check" class="w-3 h-3"></i> ã‚³ãƒ”ãƒ¼å®Œäº†';
                    lucide.createIcons();
                    setTimeout(() => {
                        copyCodeBtn.innerHTML = originalText;
                        lucide.createIcons();
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy text: ', err);
                });
            });
        };

        window.onload = initializeApp;

    </script>
</body>
</html>
